@model List<TeamWithSpecialPerson>

<section class="container">
    <h2 >Информация по воинским частям</h2>
</section>

<section class="container mt-4 mb-2 ">
    <div class="row align-items-end">
        <div class="col-lg-8">
            <h5>Всего по директивным указаниям (персональщики и семейные): <b>@ViewData["personsCount"]</b> чел.</h5>
        </div>
        <div class="col-lg-4 text-right">
            <a asp-controller="PersonalGuidance" asp-action="CreateModal" class="btn btn-success" id="createModalBtn"> <i class="fas fa-user-plus"></i> Добавить</a>
        </div>
    </div>
</section>

<section class="container">
    <div class="mvc-grid">
        <table class="table table-hover table-bordered table-label-hide">
            <thead class="thead-dark">
            <tr>
                <th colspan="3">Воинская часть</th>
                <th class="w-px-110">Задание</th>
                <th class="w-px-170">Персональщиков</th>
                <th class="w-px-150">Шефские связи</th>
                <th class="w-px-120">Остаток</th>
                <th class="w-px-70"></th>
            </tr>
            </thead>
            @foreach (var team in Model)
            {
                <tbody class="label">
                <tr class="border-top @(team.RemainCount < 0 ? "bg-warning" : "table-primary")">
                    <td class="font-weight-bold" colspan="3">
                        <label for="team-@team.MainTeam.MilitaryUnitCode">
                            @team.MainTeam.ArmyType.Name, @(team.MainTeam.MilitaryDistrict.ShortName != "-" ? team.MainTeam.MilitaryDistrict.ShortName + ", " : "")№ в/ч @team.MainTeam.MilitaryUnitCode, ст. @team.MainTeam.MilitaryUnit.Name
                        </label>
                        <input data-toggle="toggle" id="team-@team.MainTeam.MilitaryUnitCode" name="team-@team.MainTeam.MilitaryUnitCode" type="checkbox">
                    </td>
                    <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Задание">@team.AllCount</td>
                    <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Персональщиков">@team.PersonsCount</td>
                    <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Шефские связи">@team.PatronageRecruitsCount</td>
                    <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Остаток">@team.RemainCount</td>
                    <td class="wpx-70"></td>
                </tr>
                </tbody>
                <tbody class="hide">
                @foreach (var childrenTeam in team.ChildrenTeams)
                {
                    <tr class="@(childrenTeam.RemainCount < 0 ? "bg-warning" : "table-secondary")">
                        <td class="font-weight-bold" colspan="3">
                            Отправка со СП, @childrenTeam.Title
                        </td>
                        <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Задание">@childrenTeam.AllCount</td>
                        <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Персональщиков">@childrenTeam.PersonsCount</td>
                        <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Шефские связи: @childrenTeam.GetPatronageTasksText()">@childrenTeam.GetPatrinageCount()</td>
                        <td class="font-weight-bold text-center" data-placement="top" data-toggle="tooltip" title="Остаток">@childrenTeam.RemainCount</td>
                        <td class="font-weight-bold"></td>
                    </tr>
                    var index = 1;
                    @foreach (var person in childrenTeam.Persons)
                    {
                        <tr>
                            <td style="text-align: center">@(index++).</td>
                            <td>@person.FullName</td>
                            <td>@(person.BirthYear)г.</td>
                            <td colspan="2">@person.MilitaryComissariat.ShortName</td>
                            <td>@person.Requirement.RequirementType.Name</td>
                            <td>@person.SendDateString</td>
                            <td>
                                <button class='btn btn-success btnEditPerson' onclick="editPerson('@Url.Action("EditModal", "PersonalGuidance", new {id = person.Id})')">
                                    <i class='fas fa-edit'></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            }
        </table>
    </div>
</section>

<div id="modalContainer"></div>

@section Scripts
{
    <script>
    
    function editPerson(url) {
        $('.btnEditPerson').attr('disabled','');
        $("#modalContainer").load(url, function (responseText, textStatus) {
            if (textStatus === "error") {
                $('.btnEditPerson').removeAttr('disabled');
                alert("Не удалось загрузить Персональщика")
            } else {
                let editModal = $('#editModal')
                editModal.modal('toggle');
                editModal.on('hidden.bs.modal', function () {
                    $("#modalContainer").html("")
                })
            }  
        })
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        $('[data-toggle="tooltip"]').tooltip()
        document.getElementById('createModalBtn').addEventListener('click', function(e) {
            e.preventDefault()
            let url = $(this).attr('href')
            
            $("#modalContainer").load(url, function (responseText, textStatus) {
                if (textStatus === "error") {
                    alert("Не удалось загрузить Персональщика")
                } else {
                    let createModal = $("#createModal")
                    createModal.modal('toggle');
                    createModal.on('hidden.bs.modal', function () {
                        $("#modalContainer").html("")
                    })
                }  
            })
        })
        document.querySelector('[data-toggle="toggle"]').addEventListener('change', function () {
            $(this).parents().next('.hide').toggle();
        });
    })
    </script>
}